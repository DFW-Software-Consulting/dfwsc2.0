---
title: "Hash API Keys at Rest – Plan"
phase: Plan
date: "2026-01-17T20:15:00Z"
owner: "agent"
parent_research: "memory-bank/tickets/2026-01-17/05-hash-api-keys.md"
git_commit_at_plan: "e983f41"
tags: [plan, security, api-keys, hashing]
---

## Goal

**Store API keys as bcrypt hashes in the database instead of plaintext** to eliminate credential exposure risk if the database is compromised.

**Non-goals:**
- Key rotation mechanism (future ticket)
- Multiple API keys per client (future ticket)
- Audit logging of API key usage (separate concern)

## Scope & Assumptions

**In Scope:**
- Hash new API keys with bcrypt before database storage
- Update validation to compare against hashes using bcrypt.compare()
- Add database column `api_key_hash` (new column approach for safe migration)
- One-time migration to hash existing plaintext keys
- Update one integration test to verify hashed validation

**Out of Scope:**
- Changing the API key generation algorithm (already uses crypto.randomBytes - secure)
- Rate limiting improvements
- Key versioning or rotation

**Assumptions:**
- bcryptjs is already installed and proven (used for admin passwords)
- Existing clients have plaintext API keys that must remain functional during migration
- Docker environment will run migrations automatically on startup

## Deliverables (DoD)

| Artifact | Acceptance Criteria |
|----------|---------------------|
| `api_key_hash` column | Column exists in `clients` table, nullable |
| Hash on creation | New API keys stored as bcrypt hash, plaintext returned to admin once |
| Hash validation | `requireApiKey` middleware validates against hash using bcrypt.compare() |
| Migration script | All existing plaintext keys are hashed, `api_key` column cleared |
| Schema update | Drizzle schema reflects new column |
| One integration test | Verifies hashed API key authentication works |

## Readiness (DoR)

- [x] bcryptjs installed (`^2.4.3` in package.json)
- [x] Existing password hash pattern in `/backend/src/lib/auth.ts`
- [x] Drizzle migration infrastructure working
- [x] Docker environment functional
- [x] Identified all files touching API keys (5 files)

## Milestones

| ID | Milestone | Description |
|----|-----------|-------------|
| M1 | Schema & Column | Add `api_key_hash` column to schema and generate migration |
| M2 | Hash on Create | Update `generateApiKey()` flow to hash before storage |
| M3 | Validate from Hash | Update `requireApiKey()` to use bcrypt.compare() |
| M4 | Data Migration | Hash existing plaintext keys, clear plaintext column |
| M5 | Test & Verify | Run one integration test, verify in Docker |

## Work Breakdown (Tasks)

### T1: Add `api_key_hash` column to schema
- **Milestone:** M1
- **Owner:** agent
- **Dependencies:** none
- **Files:** `backend/src/db/schema.ts`
- **Acceptance Tests:**
  - [ ] `api_key_hash` column defined as `text().unique()` in schema
  - [ ] Column is nullable (for migration period)

### T2: Generate Drizzle migration
- **Milestone:** M1
- **Owner:** agent
- **Dependencies:** T1
- **Files:** `backend/drizzle/0003_*.sql`
- **Acceptance Tests:**
  - [ ] Migration file created with `ALTER TABLE clients ADD COLUMN api_key_hash`
  - [ ] Uses `IF NOT EXISTS` for idempotency

### T3: Create `hashApiKey()` utility function
- **Milestone:** M2
- **Owner:** agent
- **Dependencies:** none
- **Files:** `backend/src/lib/auth.ts`
- **Acceptance Tests:**
  - [ ] Function uses bcrypt.hash() with cost factor 10
  - [ ] Returns hashed string

### T4: Update API key creation to store hash
- **Milestone:** M2
- **Owner:** agent
- **Dependencies:** T1, T3
- **Files:** `backend/src/routes/connect.ts`
- **Acceptance Tests:**
  - [ ] `createClientWithOnboardingToken()` stores hash in `api_key_hash`
  - [ ] Plaintext returned to admin in response (one-time display)
  - [ ] `api_key` column left null for new clients

### T5: Update `requireApiKey()` middleware
- **Milestone:** M3
- **Owner:** agent
- **Dependencies:** T3
- **Files:** `backend/src/lib/auth.ts`
- **Acceptance Tests:**
  - [ ] Fetches all clients with non-null `api_key_hash`
  - [ ] Uses bcrypt.compare() to validate
  - [ ] Falls back to plaintext check during migration period (optional)

### T6: Data migration script for existing keys
- **Milestone:** M4
- **Owner:** agent
- **Dependencies:** T2, T3
- **Files:** `backend/drizzle/0003_*.sql` or `backend/src/lib/migrate-api-keys.ts`
- **Acceptance Tests:**
  - [ ] All existing `api_key` values hashed into `api_key_hash`
  - [ ] Original `api_key` column set to NULL after migration
  - [ ] Idempotent (safe to run multiple times)

### T7: Update one integration test
- **Milestone:** M5
- **Owner:** agent
- **Dependencies:** T4, T5
- **Files:** `backend/src/__tests__/integration/payments-api-key.test.ts`
- **Acceptance Tests:**
  - [ ] Test creates client with hashed key
  - [ ] Test validates API request succeeds with correct key

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation | Trigger |
|------|--------|------------|------------|---------|
| Existing clients locked out | High | Medium | Keep plaintext fallback during migration window | Any 401 errors post-deploy |
| bcrypt cost too high (slow auth) | Medium | Low | Use cost factor 10 (same as passwords) | Auth latency > 200ms |
| Migration fails mid-way | Medium | Low | Idempotent migration, can re-run safely | Migration error in logs |

## Test Strategy

**Single Integration Test Update:**
- Modify `backend/src/__tests__/integration/payments-api-key.test.ts`
- Test: Create client → receive plaintext key → make payment request with key → verify 200 response
- This validates the full hash-on-create and validate-from-hash flow

## References

- Ticket: `memory-bank/tickets/2026-01-17/05-hash-api-keys.md`
- API key storage: `backend/src/routes/connect.ts:27-29` (generateApiKey)
- Auth middleware: `backend/src/lib/auth.ts:21-39` (requireApiKey)
- Schema: `backend/src/db/schema.ts:7` (api_key column)
- Existing bcrypt pattern: `backend/src/lib/auth.ts:16-18` (verifyPassword)
- Migration examples: `backend/drizzle/0001_client_api_keys.sql`

---

## Alternative Approach (Not Recommended)

**SHA-256 with prefix storage:** Store first 8 chars of key + SHA-256 hash. Allows lookup by prefix, then validate full key.
- **Downside:** More complex, prefix leaks partial key info.
- **Decision:** Use bcrypt for consistency with password hashing pattern already in codebase.

---

## Final Gate

| Item | Value |
|------|-------|
| Plan path | `memory-bank/plan/2026-01-17_20-15-00_hash-api-keys.md` |
| Milestones | 5 |
| Tasks | 7 |
| Gates | Schema migration, hash creation, hash validation, data migration, test pass |
| Next command | `/ce-ex memory-bank/plan/2026-01-17_20-15-00_hash-api-keys.md` |
