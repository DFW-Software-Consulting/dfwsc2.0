# Testing Guide

This guide aggregates manual and automated testing workflows for the Stripe Payment Portal.

## Automated Tests
- Run `npm test` to execute Vitest suites. These cover:
  - Environment validation (`src/lib/env.ts`).
  - Route guards and idempotency headers.
  - Happy-path onboarding, payment creation, and webhook handling with mocked Stripe responses.
- External services are stubbed: the tests mock MailHog’s HTTP API and Nodemailer transport so they pass without Docker
  containers or a running SMTP service.
- Add new tests under `src/__tests__/` and update documentation when coverage changes.

## Stripe Webhook Replay
- Authenticate with the Stripe CLI (`stripe login`) and ensure it can reach your local Fastify server.
- Run `make test-stripe` to trigger the platform event set defined in `test-stripe-events.sh`.
- Update the `CONNECTED_ACCT` placeholder in that script with a real test-mode connected account ID before enabling the
  connected account triggers.
- Monitor the API logs and database (`webhook_events` table) to verify events are persisted and processed.

## Manual API Checks
### Onboarding
```bash
curl -X POST http://localhost:4242/connect/onboard \
  -H 'Content-Type: application/json' \
  -H 'Idempotency-Key: manual-onboard-1' \
  -H 'x-api-role: admin' \
  -d '{"clientId":"manual_1","name":"Manual Test Co","email":"manual@example.com"}'
```
- Confirm the response includes an onboarding URL and Stripe account ID.
- Visit the returned URL to walk through the Stripe Express onboarding screens.

### Payments
```bash
curl -X POST http://localhost:4242/payments/create \
  -H 'Content-Type: application/json' \
  -H 'Idempotency-Key: manual-payment-1' \
  -H 'x-api-role: admin' \
  -d '{"clientId":"manual_1","amount":5000,"currency":"usd"}'
```
- Expect a `clientSecret` response (PaymentIntent mode). Use Stripe’s test cards (e.g., `4242 4242 4242 4242`) to confirm completion.

### Reports
```bash
curl "http://localhost:4242/reports/payments?clientId=manual_1&limit=5" \
  -H 'x-api-role: admin'
```
- Verify the resulting list contains the PaymentIntent created above.

### Webhooks
1. Start Stripe CLI forwarding: `stripe listen --forward-to localhost:4242/webhooks/stripe`.
2. Trigger an event: `stripe trigger payment_intent.succeeded`.
3. Query the DB to confirm persistence:
   ```bash
   psql $DATABASE_URL -c "SELECT stripe_event_id, type FROM webhook_events ORDER BY created_at DESC LIMIT 5;"
   ```

## Debugging Tips
- Use `docker compose logs -f api` to watch server output during manual tests.
- Enable Fastify request logging (`LOGGER=1` environment variable) if deeper tracing is required.
- Keep Stripe Dashboard open in Test mode to cross-reference events generated by the tests above.
