---
title: "Admin Reset Path â€“ Plan"
phase: Plan
date: "2026-01-27T15:49:49"
owner: "developer"
parent_research: "memory-bank/tickets/2026-01-27_admin-reset-path.md"
git_commit_at_plan: "2bb882a"
tags: [plan, admin-reset-path, security, onboarding]
---

## Goal

**Implement a one-time browser-accessible admin credential setup mechanism** that enables initial admin configuration without CLI access, activated only via environment flag, and auto-disabled after first successful setup.

**Non-goals:**
- Password reset for existing admins (out of scope)
- Multi-admin support (out of scope)
- Database-stored admin accounts (out of scope)
- Always-on unauthenticated endpoints (security risk)

## Scope & Assumptions

### In Scope
- Backend: New `/api/v1/auth/setup/status` GET endpoint
- Backend: New `/api/v1/auth/setup` POST endpoint for one-time setup
- Frontend: Conditional setup form on `/admin` when setup is allowed
- Environment variable `ALLOW_ADMIN_SETUP` support
- Optional `ADMIN_SETUP_TOKEN` header protection
- Documentation updates

### Out of Scope
- CLI-based admin reset tools
- Database admin table creation
- Multi-tenant admin management
- Existing password change functionality

### Assumptions
- Docker environment is running for all testing
- Current env-based admin auth pattern is preserved
- Single admin account architecture remains unchanged

## Deliverables (DoD)

| Artifact | Acceptance Criteria |
|----------|---------------------|
| `GET /api/v1/auth/setup/status` | Returns `{ setupAllowed: boolean, adminConfigured: boolean }` |
| `POST /api/v1/auth/setup` | Creates admin hash, returns hash for env storage, works ONLY when `ALLOW_ADMIN_SETUP=true` AND no admin configured |
| Frontend setup form | Shows on `/admin` when backend indicates setup allowed; hidden after setup complete |
| Documentation | Updated `backend/README.md` with recovery flow |

## Readiness (DoR)

- [x] Docker environment functional
- [x] Current auth routes understood (backend/src/routes/auth.ts)
- [x] Frontend admin flow understood (AdminLogin.jsx, AdminDashboard.jsx)
- [x] Environment variable patterns established (backend/src/lib/env.ts)
- [x] bcrypt usage patterns confirmed (backend/src/lib/auth.ts)

## Milestones

### M1: Backend Setup Endpoints
Create the two new endpoints with proper guards.

### M2: Frontend Setup UI
Add conditional setup form to AdminDashboard.

### M3: Integration & Testing
End-to-end validation with one integration test.

### M4: Documentation
Update deployment docs with recovery flow.

## Work Breakdown (Tasks)

### Task 1: Add ALLOW_ADMIN_SETUP environment variable support
**Owner:** Developer
**Milestone:** M1
**Dependencies:** None

**Files/Interfaces:**
- `backend/src/lib/env.ts` - Add optional ALLOW_ADMIN_SETUP to optionalEnvSchema
- `backend/src/lib/env.ts` - Add optional ADMIN_SETUP_TOKEN to optionalEnvSchema

**Acceptance Tests:**
- Server starts without ALLOW_ADMIN_SETUP set (default false behavior)
- ALLOW_ADMIN_SETUP=true is readable from env

---

### Task 2: Implement GET /api/v1/auth/setup/status endpoint
**Owner:** Developer
**Milestone:** M1
**Dependencies:** Task 1

**Files/Interfaces:**
- `backend/src/routes/auth.ts` - Add new route handler

**Logic:**
```
{
  setupAllowed: ALLOW_ADMIN_SETUP === 'true' && !adminConfigured,
  adminConfigured: !!ADMIN_PASSWORD
}
```

**Acceptance Tests:**
- Returns `{ setupAllowed: false, adminConfigured: true }` when ADMIN_PASSWORD set
- Returns `{ setupAllowed: true, adminConfigured: false }` when ALLOW_ADMIN_SETUP=true and no ADMIN_PASSWORD

---

### Task 3: Implement POST /api/v1/auth/setup endpoint
**Owner:** Developer
**Milestone:** M1
**Dependencies:** Task 1, Task 2

**Files/Interfaces:**
- `backend/src/routes/auth.ts` - Add new route handler

**Logic:**
1. Check ALLOW_ADMIN_SETUP=true AND no ADMIN_PASSWORD set
2. If ADMIN_SETUP_TOKEN env set, validate header matches
3. Accept { username, password } body
4. Generate bcrypt hash of password
5. Return { username, passwordHash, instructions }
6. Disable ALLOW_ADMIN_SETUP in runtime (set flag in memory)

**Acceptance Tests:**
- Returns 403 when ALLOW_ADMIN_SETUP not true
- Returns 403 when admin already configured
- Returns 401 when ADMIN_SETUP_TOKEN required but not provided
- Returns bcrypt hash on success
- Subsequent calls return 403 (one-time use)

---

### Task 4: Implement AdminSetup frontend component
**Owner:** Developer
**Milestone:** M2
**Dependencies:** Task 2, Task 3

**Files/Interfaces:**
- `front/src/components/admin/AdminSetup.jsx` - New component
- `front/src/components/admin/AdminDashboard.jsx` - Integration

**Logic:**
1. On mount, fetch `/auth/setup/status`
2. If `setupAllowed=true`, show setup form instead of login
3. On submit, POST to `/auth/setup`
4. Display returned hash with copy button and env instructions
5. After success, refresh status (should now show login)

**Acceptance Tests:**
- Shows setup form when setupAllowed=true
- Shows login form when setupAllowed=false
- Displays hash with copy-to-clipboard after successful setup
- Shows clear instructions about persisting hash to env

---

### Task 5: Write integration test for setup flow
**Owner:** Developer
**Milestone:** M3
**Dependencies:** Task 3

**Files/Interfaces:**
- `backend/src/__tests__/integration/admin-setup.test.ts` - New test file

**Test Scenarios (ONE test file):**
- Setup endpoint returns 403 when disabled
- Setup endpoint works when enabled, returns valid bcrypt hash

---

### Task 6: Update documentation
**Owner:** Developer
**Milestone:** M4
**Dependencies:** Task 1-4

**Files/Interfaces:**
- `backend/README.md` - Add admin recovery section

**Content:**
- How to enable admin setup mode
- Security implications
- Step-by-step recovery flow

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation | Trigger |
|------|--------|------------|------------|---------|
| Setup endpoint left enabled in production | High | Low | Auto-disable after first use + env flag required | Deploy checklist |
| Token brute-force | Medium | Low | Rate limiting on setup endpoint | Monitor 403 responses |
| Memory flag reset on container restart | Medium | Medium | Document that container restart re-enables if env still set | User confusion |

## Test Strategy

**ONE integration test file:** `backend/src/__tests__/integration/admin-setup.test.ts`
- Test 403 when ALLOW_ADMIN_SETUP not set
- Test successful setup returns bcrypt hash
- Test subsequent setup attempts fail (one-time use)

## References

- Research doc: `memory-bank/tickets/2026-01-27_admin-reset-path.md`
- Current auth routes: `backend/src/routes/auth.ts:49-116`
- Current env schema: `backend/src/lib/env.ts:4-17`
- Frontend login: `front/src/components/admin/AdminLogin.jsx`
- Frontend dashboard: `front/src/components/admin/AdminDashboard.jsx:103-115`

## Alternative Approach (Not Recommended)

**CLI-based reset script:** Could add `npm run admin:reset` script that generates hash.

**Why not chosen:** Ticket explicitly requires browser-accessible solution with no CLI path. Many deployment environments (Coolify, Railway, etc.) don't provide easy CLI access.

---

## Final Gate Summary

| Item | Value |
|------|-------|
| Plan Path | `memory-bank/plan/2026-01-27_15-49-49_admin-reset-path.md` |
| Milestones | 4 (M1: Backend, M2: Frontend, M3: Testing, M4: Docs) |
| Tasks | 6 |
| New Test Files | 1 |
| Files Modified | ~5 (env.ts, auth.ts, AdminSetup.jsx, AdminDashboard.jsx, README.md) |
| Files Created | 2 (AdminSetup.jsx, admin-setup.test.ts) |

**Next Command:** `/ce-ex "memory-bank/plan/2026-01-27_15-49-49_admin-reset-path.md"`
