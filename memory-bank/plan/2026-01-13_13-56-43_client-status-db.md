---
title: "Client Status (Soft Delete) – Plan"
phase: Plan
date: "2026-01-13_13-56-43"
owner: "plan-agent"
parent_research: "memory-bank/tickets/02-client-status-db.md"
git_commit_at_plan: "not a git repo"
tags: [plan, client-status, soft-delete, database]
---

## Goal

Add soft-delete capability to the clients table by introducing a `status` field that allows marking clients as `inactive` without data loss. Enable admin-only API endpoint to toggle client status.

**Non-Goals**:
- Hard deletion of client records
- Cascading soft-delete to related entities (webhook_events, onboarding_tokens)
- UI implementation for client management
- Automatic filtering in all existing queries (will be addressed incrementally)

## Scope & Assumptions

**In Scope**:
- Add `status` enum field to clients table (`active` | `inactive`)
- Database migration with default value `active` for existing clients
- New admin-only endpoint `PATCH /api/v1/clients/:id` to update client status
- Schema validation update to include status field
- Unit tests for new endpoint

**Out of Scope**:
- Filtering inactive clients in LIST endpoints (no list endpoint exists yet)
- UI components for client management
- Email notifications on status change
- Audit logging of status changes
- Automatic archival after N days

**Assumptions**:
- PostgreSQL 14+ database is running and accessible
- Admin authentication via JWT is working (`requireAdminJwt` middleware)
- Drizzle ORM migration workflow is functional
- Existing client queries do NOT need immediate filtering (decision: inactive clients remain queryable)

**Constraints**:
- Must maintain backward compatibility (all existing clients become `active`)
- No breaking changes to existing API endpoints
- Migration must be reversible
- Admin-only access enforced via existing auth middleware

## Deliverables (DoD)

1. **Database Migration**:
   - Generated SQL migration file in `drizzle/` directory
   - Successfully applied to database
   - All existing clients have `status = 'active'`

2. **Schema Update**:
   - `clients` table in `backend/src/db/schema.ts` includes `status` field with proper type and default
   - Schema check in `backend/src/lib/schema-check.ts` validates presence of `status` column

3. **API Endpoint**:
   - `PATCH /api/v1/clients/:id` endpoint implemented
   - Request validation: only `status` field allowed in body
   - Admin-only access enforced
   - Returns updated client record
   - Proper error handling (404 for missing client, 400 for invalid status, 403 for non-admin)

4. **Tests**:
   - Unit test for successful status update (admin request)
   - Unit test for 403 rejection (non-admin request)

5. **Documentation**:
   - API endpoint documented in code comments
   - Migration process documented in commit message

## Readiness (DoR)

**Preconditions**:
- PostgreSQL database is running (Docker or local)
- `DATABASE_URL` environment variable configured
- Node.js and npm installed
- Backend dependencies installed (`npm install` in backend/)
- Existing schema has clients table with id, name, email, stripeAccountId, createdAt, updatedAt

**Data Requirements**:
- No specific test data required (can test with empty or seeded database)

**Access Requirements**:
- Database write permissions
- Admin credentials (`ADMIN_USERNAME`, `ADMIN_PASSWORD`) for testing

**Environment Setup**:
- Development environment with hot-reload enabled
- Ability to run `npm run db:generate` and `npm run db:migrate`

## Milestones

**M1: Schema & Migration** (Foundation)
- Update schema.ts with status field
- Generate and review migration SQL
- Apply migration to database
- Update schema-check.ts validation

**M2: API Endpoint** (Core Feature)
- Create PATCH /api/v1/clients/:id route handler
- Implement request validation
- Add requireAdminJwt middleware
- Wire up route in app.ts

**M3: Tests** (Validation)
- Write unit test for successful status update
- Deploy and run tests to confirm functionality

## Work Breakdown (Tasks)

### Task 1: Update Database Schema
**Owner**: Developer
**Dependencies**: None
**Target Milestone**: M1
**Estimate**: Small
**Files Touched**:
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/db/schema.ts`

**Description**:
Add `status` field to clients table definition with enum type and default value.

**Implementation**:
```typescript
status: text("status", { enum: ["active", "inactive"] })
  .default("active")
  .notNull(),
```

**Acceptance Tests**:
- [ ] Schema compiles without TypeScript errors
- [ ] Field has correct enum values: "active" | "inactive"
- [ ] Default value is "active"
- [ ] Field is marked as notNull

---

### Task 2: Generate and Apply Database Migration
**Owner**: Developer
**Dependencies**: Task 1
**Target Milestone**: M1
**Estimate**: Small
**Files Touched**:
- `drizzle/` directory (generated migration SQL)

**Description**:
Generate migration SQL using Drizzle Kit and apply to database.

**Commands**:
```bash
cd backend
npm run db:generate  # Creates migration file
npm run db:migrate   # Applies migration
```

**Acceptance Tests**:
- [ ] Migration file generated in `drizzle/` directory
- [ ] Migration SQL adds `status` column with correct type (enum or text with constraint)
- [ ] Migration SQL sets default value to 'active'
- [ ] Migration SQL sets NOT NULL constraint
- [ ] Migration SQL includes migration to set existing rows to 'active'
- [ ] Migration applies without errors
- [ ] Verify in database: `\d clients` shows status column with default 'active'

---

### Task 3: Update Schema Validation
**Owner**: Developer
**Dependencies**: Task 2
**Target Milestone**: M1
**Estimate**: Trivial
**Files Touched**:
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/lib/schema-check.ts`

**Description**:
Add 'status' to the list of required columns in schema validation.

**Implementation**:
Update the `requiredColumns` array for clients table to include 'status'.

**Acceptance Tests**:
- [ ] Schema check passes at server startup
- [ ] If status column is missing, schema check fails with descriptive error

---

### Task 4: Create PATCH /api/v1/clients/:id Endpoint
**Owner**: Developer
**Dependencies**: Task 2, Task 3
**Target Milestone**: M2
**Estimate**: Medium
**Files Touched**:
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/routes/clients.ts` (new file)
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/app.ts`

**Description**:
Create new route handler for updating client status via PATCH request.

**Implementation Details**:
1. Create new file `src/routes/clients.ts`
2. Define route: `PATCH /api/v1/clients/:id`
3. Apply `requireAdminJwt` preHandler middleware
4. Validate request body contains only `status` field with valid enum value
5. Query database for client by ID
6. Return 404 if client not found
7. Update client status using Drizzle ORM
8. Return updated client record (200 OK)

**Request Schema**:
```typescript
{
  body: {
    status: 'active' | 'inactive'
  },
  params: {
    id: string
  }
}
```

**Response Schema (200)**:
```typescript
{
  id: string,
  name: string,
  email: string,
  stripeAccountId: string | null,
  status: 'active' | 'inactive',
  createdAt: string,
  updatedAt: string
}
```

**Error Responses**:
- 400: Invalid status value
- 401: Missing or invalid JWT token
- 403: Non-admin role
- 404: Client not found

**Acceptance Tests**:
- [ ] Endpoint registered at `PATCH /api/v1/clients/:id`
- [ ] requireAdminJwt middleware applied
- [ ] Valid admin request with status='inactive' updates client and returns 200
- [ ] Valid admin request with status='active' updates client and returns 200
- [ ] Request with invalid status value returns 400
- [ ] Request without JWT returns 401
- [ ] Request with non-admin JWT returns 403
- [ ] Request with non-existent client ID returns 404
- [ ] Response includes all client fields including updated status
- [ ] Database record is actually updated (not just response)

---

### Task 5: Register Client Routes in Application
**Owner**: Developer
**Dependencies**: Task 4
**Target Milestone**: M2
**Estimate**: Trivial
**Files Touched**:
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/app.ts`

**Description**:
Import and register the new clients route plugin in the Fastify application.

**Implementation**:
```typescript
import clientRoutes from './routes/clients'
// ...
await app.register(clientRoutes)
```

**Acceptance Tests**:
- [ ] Server starts without errors
- [ ] Endpoint accessible at runtime
- [ ] Route appears in Fastify route list (if debugging enabled)

---

### Task 6: Write Unit Test for Status Update Endpoint
**Owner**: Developer
**Dependencies**: Task 5
**Target Milestone**: M3
**Estimate**: Small
**Files Touched**:
- `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/routes/clients.test.ts` (new file)

**Description**:
Create unit test suite for the PATCH endpoint covering success and auth failure cases.

**Test Cases**:
1. **Success: Admin updates client to inactive**
   - Setup: Create test client, generate admin JWT
   - Action: PATCH /api/v1/clients/:id with status='inactive'
   - Assert: 200 response, status field updated in response and database

2. **Failure: Non-admin attempts update**
   - Setup: Create test client, generate non-admin JWT (or no JWT)
   - Action: PATCH /api/v1/clients/:id with status='inactive'
   - Assert: 401 or 403 response

**Acceptance Tests**:
- [ ] Test file created with at least 2 test cases
- [ ] Tests pass when run via `npm test`
- [ ] Tests use test database or mocked database client
- [ ] Tests clean up test data after execution

---

## Risks & Mitigations

| Risk | Impact | Likelihood | Mitigation | Trigger |
|------|--------|-----------|------------|---------|
| Migration fails on existing data | High | Low | Test migration on copy of production data; migration includes default value for existing rows | Before applying to production |
| Existing queries break when expecting only active clients | Medium | Low | Current decision: do NOT filter by status in existing queries; document behavior | Code review catches unintended filtering |
| Enum type incompatibility across databases | Medium | Low | Use text field with check constraint instead of native enum if needed | Database compatibility testing |
| Admin JWT secret compromised | High | Low | Use strong secret, rotate periodically, implement token expiry | Security audit |
| Missing status field in legacy code paths | Low | Medium | Schema validation at startup catches missing column | Startup schema check fails |

---

## Test Strategy

**Unit Tests**:
- Test PATCH endpoint success case (admin updates status)
- Test PATCH endpoint auth failure (non-admin rejected)

**Integration Tests** (Future):
- End-to-end test: admin login → create client → update status → verify database
- Test that inactive clients can still be queried in payment/onboarding flows

**Manual Testing Checklist**:
1. Apply migration and verify schema
2. Start server and check logs for schema validation
3. Login as admin and get JWT token
4. Create test client via POST /api/v1/accounts
5. Update client status to 'inactive' via PATCH
6. Verify response and database record
7. Attempt update without admin token (expect 401/403)
8. Attempt update with invalid status value (expect 400)
9. Attempt update with non-existent client ID (expect 404)

**Regression Testing**:
- Verify existing endpoints still work:
  - POST /api/v1/accounts (creates client with status='active')
  - POST /api/v1/onboard-client/initiate
  - GET /api/v1/onboard-client
  - POST /api/v1/payments/create

---

## Open Questions (To Be Resolved Before Execution)

1. **Inactive Client Behavior**: Should inactive clients be hidden from list endpoints (when implemented), or shown with status indicator?
   - **Decision Needed**: Document in ticket notes
   - **Recommendation**: Show with status indicator for admin transparency

2. **Status Transition Rules**: Can clients be reactivated (inactive → active)?
   - **Current Plan**: Yes, both directions allowed
   - **Alternative**: One-way transition only (would require additional validation)

3. **Stripe Account Handling**: Should inactive clients have their Stripe accounts detached?
   - **Current Plan**: No cascading changes to Stripe
   - **Future Enhancement**: Optionally disable Stripe payouts

4. **Related Entity Filtering**: Should onboarding tokens for inactive clients be invalidated?
   - **Current Plan**: No immediate changes
   - **Future Enhancement**: Add status check in onboarding flow

---

## References

**Source Ticket**: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/memory-bank/tickets/02-client-status-db.md`

**Key Files**:
- Schema: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/db/schema.ts:9-16`
- Auth Middleware: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/lib/auth.ts:49-77`
- Schema Validation: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/lib/schema-check.ts:12-35`
- Migration Config: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/drizzle.config.ts`
- App Routes: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/backend/src/app.ts:16-23`

**Related Endpoints** (for reference):
- POST /api/v1/accounts (creates clients)
- POST /api/v1/auth/login (admin authentication)

**External Documentation**:
- Drizzle ORM Migrations: https://orm.drizzle.team/docs/migrations
- Fastify Route Handler: https://fastify.dev/docs/latest/Reference/Routes/

---

## Agents

This plan will deploy the following subagents during execution:

1. **codebase-analyzer**: Analyze existing client query patterns to ensure status field doesn't break current functionality
2. **context-synthesis**: After implementation, synthesize changes and verify no unintended side effects in related flows (onboarding, payments, webhooks)

Maximum concurrent subagents: 2

---

## Alternative Approach (Documented for Consideration)

**Alternative: Use `deletedAt` timestamp instead of status enum**

**Pros**:
- Captures when deletion occurred (audit trail)
- Supports "undelete" by clearing timestamp
- Common pattern in industry

**Cons**:
- Requires nullable timestamp field
- More complex queries (WHERE deletedAt IS NULL)
- Doesn't distinguish between active/inactive/archived states

**Decision**: Proceed with `status` enum as specified in ticket. The enum approach is simpler, more explicit, and aligns with ticket requirements. If audit trail is needed later, add separate `statusChangedAt` timestamp field.

---

## Final Gate

**Plan Summary**:
- **Plan Path**: `/home/jeremy/jcFolder/dfwsc/dfwsc2.0/memory-bank/plan/2026-01-13_13-56-43_client-status-db.md`
- **Milestones**: 3 (Schema & Migration, API Endpoint, Tests)
- **Tasks**: 6 total
- **Gates**:
  - M1 complete when migration applied and schema validated
  - M2 complete when PATCH endpoint accessible and registered
  - M3 complete when unit tests pass
- **Estimated Complexity**: Small-to-Medium (mostly straightforward DB and API work)

**Next Steps**:
```bash
/execute "/home/jeremy/jcFolder/dfwsc/dfwsc2.0/memory-bank/plan/2026-01-13_13-56-43_client-status-db.md"
```

**Execution Focus**:
This is a singular, focused plan targeting database schema enhancement and admin API endpoint creation. The core goal is enabling soft-delete capability without breaking existing functionality. Execution should proceed sequentially through milestones M1 → M2 → M3.
